<form class="cw flexcol" autocomplete="off">
  <header class="sheet-header">
    <img class="profile-img" src="{{actor.img}}" title="{{actor.name}}" height="64" width="64"/>
    <h1 class="charname"><input name="name" type="text" value="{{actor.name}}" placeholder="Name"/></h1>
  </header>

  <nav class="sheet-tabs tabs" data-group="primary">
    <a class="item" data-tab="core">Core</a>
    <a class="item" data-tab="skills">Skills</a>
    <a class="item" data-tab="traits">Traits</a>
    <a class="item" data-tab="backgrounds">Backgrounds</a>
    <a class="item" data-tab="notes">Notes</a>
  </nav>

  <section class="sheet-body">
    <!-- CORE TAB -->
    <div class="tab core" data-group="primary" data-tab="core">
      <div class="grid-3col">
        <section>
          <h3>Attributes</h3>
          {{#each system.attributes as |val key|}}
            <div class="resource">
              <label>{{uppercase key}}</label>
              <input type="number" name="system.attributes.{{key}}" value="{{val}}" min="0" max="10"/>
            </div>
          {{/each}}
        </section>

        <section>
          <h3>Vitals</h3>
          <div class="resource">
            <label>Will (Perm)</label>
            <input type="number" name="system.vitals.will_perm" value="{{system.vitals.will_perm}}" min="0" max="10"/>
          </div>
          <div class="resource">
            <label>Will (Curr)</label>
            <input type="number" name="system.vitals.will_curr" value="{{system.vitals.will_curr}}" min="0" max="10"/>
          </div>
          <div class="resource">
            <label>Health Lvls</label>
            <input type="number" name="system.vitals.health_levels" value="{{system.vitals.health_levels}}" min="0" max="7"/>
          </div>
          <div class="resource">
            <label>Wound Pen</label>
            <input type="number" name="system.vitals.wound_pen" value="{{system.vitals.wound_pen}}" min="-5" max="0"/>
          </div>
          <div class="resource">
            <label>Initiative</label>
            <input type="number" name="system.vitals.initiative" value="{{system.vitals.initiative}}" readonly/>
          </div>

          <h4>Health</h4>
          <div class="cw-health">
            {{#each hLabels as |lab idx|}}
              <label class="cw-hbox">
                <input type="radio" name="cw-health" data-index="{{idx}}"
                       {{#if (lte idx ../system.vitals.health.damage)}}checked{{/if}} />
                <span class="cw-hlabel">{{lab}}</span>
              </label>
            {{/each}}
          </div>
          <div class="cw-health-controls">
            <button type="button" class="cw-dmg-minus">Heal</button>
            <button type="button" class="cw-dmg-plus">Damage</button>
          </div>
        </section>

        <section>
          <h3>Test Roller</h3>
          <div>
            <label>Attribute</label>
            <select name="cw-attr">
              <option value="str">STR</option><option value="dex">DEX</option><option value="sta">STA</option>
              <option value="cha">CHA</option><option value="soc">SOC</option><option value="app">APP</option>
              <option value="int">INT</option><option value="edu">EDU</option><option value="wit">WIT</option>
            </select>
          </div>
          <div>
            <label>Skill</label>
            <select name="cw-skill">
              {{#each system.skills as |val key|}}
                <option value="{{key}}">{{capitalize key}}</option>
              {{/each}}
            </select>
          </div>
          <div><label>Specialized (10-again)</label><input type="checkbox" name="cw-spec"/></div>
          <button type="button" class="cw-roll">Roll Standard Test</button>
          <hr/>
          <button type="button" class="cw-roll-init">Roll Initiative (DEX+WIT)</button>
          <button type="button" class="cw-roll-save">Roll Save (STA+WIT)</button>
        </section>
      </div>
    </div>

    <!-- SKILLS TAB -->
    <div class="tab skills" data-group="primary" data-tab="skills">
      <div class="grid-3col">
        <section>
          <h3>Physical</h3>
          {{#each (pick system.skills "athletics" "awareness" "brawl" "drive" "martial_arts" "firearms" "heavy_weapons" "melee" "stealth" "pilot" "navigation") as |val key|}}
            <div class="resource">
              <label>{{capitalize key}}</label>
              <input type="number" name="system.skills.{{key}}" value="{{val}}" min="0" max="5"/>
              <label class="small">Spec</label>
              <input type="checkbox" name="system.specializations.{{key}}" {{checked (lookup ../system.specializations key)}}/>
              <button type="button" class="cw-skill-roll" data-skill="{{key}}">Roll</button>
            </div>
          {{/each}}
        </section>

        <section>
          <h3>Social</h3>
          {{#each (pick system.skills "business" "disguise" "empathy" "etiquette" "gambling" "gather_information" "intimidate" "leadership" "linguistics" "perform" "politics" "streetwise" "subterfuge") as |val key|}}
            <div class="resource">
              <label>{{capitalize key}}</label>
              <input type="number" name="system.skills.{{key}}" value="{{val}}" min="0" max="5"/>
              <label class="small">Spec</label>
              <input type="checkbox" name="system.specializations.{{key}}" {{checked (lookup ../system.specializations key)}}/>
              <button type="button" class="cw-skill-roll" data-skill="{{key}}">Roll</button>
            </div>
          {{/each}}
        </section>

        <section>
          <h3>Technical / Knowledge</h3>
          {{#each (pick system.skills "computer_use" "engineering" "medicine" "repair" "technology" "demolitions" "security") as |val key|}}
            <div class="resource">
              <label>{{capitalize key}}</label>
              <input type="number" name="system.skills.{{key}}" value="{{val}}" min="0" max="5"/>
              <label class="small">Spec</label>
              <input type="checkbox" name="system.specializations.{{key}}" {{checked (lookup ../system.specializations key)}}/>
              <button type="button" class="cw-skill-roll" data-skill="{{key}}">Roll</button>
            </div>
          {{/each}}
        </section>
      </div>
    </div>

    <!-- TRAITS TAB -->
    <div class="tab traits" data-group="primary" data-tab="traits">
      <div class="grid-2col">
        <section>
          <h3>
            Merits
            <a class="item-control item-create" title="Create Merit" data-type="merit">
              <i class="fas fa-plus"></i> Add
            </a>
          </h3>
          <ul class="item-list">
            {{#each merits as |item|}}
              <li class="item flexrow" data-item-id="{{item._id}}">
                <div class="item-image"><img src="{{item.img}}" title="{{item.name}}" width="24" height="24"/></div>
                <h4 class="item-name">{{item.name}}</h4>
                <div class="item-controls">
                  <a class="item-control item-edit" title="Edit Item"><i class="fas fa-edit"></i></a>
                  <a class="item-control item-delete" title="Delete Item"><i class="fas fa-trash"></i></a>
                </div>
              </li>
            {{/each}}
          </ul>

          <h3 style="margin-top: 10px;">
            Flaws
            <a class="item-control item-create" title="Create Flaw" data-type="flaw">
              <i class="fas fa-plus"></i> Add
            </a>
          </h3>
          <ul class="item-list">
            {{#each flaws as |item|}}
              <li class="item flexrow" data-item-id="{{item._id}}">
                <div class="item-image"><img src="{{item.img}}" title="{{item.name}}" width="24" height="24"/></div>
                <h4 class="item-name">{{item.name}}</h4>
                <div class="item-controls">
                  <a class="item-control item-edit" title="Edit Item"><i class="fas fa-edit"></i></a>
                  <a class="item-control item-delete" title="Delete Item"><i class="fas fa-trash"></i></a>
                </div>
              </li>
            {{/each}}
          </ul>
        </section>
        <section>
          <h3>
            Backgrounds
            <a class="item-control item-create" title="Create Background" data-type="background">
              <i class="fas fa-plus"></i> Add
            </a>
          </h3>
           <ul class="item-list">
            {{#each backgrounds as |item|}}
              <li class="item flexrow" data-item-id="{{item._id}}">
                <div class="item-image"><img src="{{item.img}}" title="{{item.name}}" width="24" height="24"/></div>
                <h4 class="item-name">{{item.name}}</h4>
                <div class="item-controls">
                  <a class="item-control item-edit" title="Edit Item"><i class="fas fa-edit"></i></a>
                  <a class="item-control item-delete" title="Delete Item"><i class="fas fa-trash"></i></a>
                </div>
              </li>
            {{/each}}
          </ul>
          <h3 style="margin-top: 10px;">
            Enhancements
            <a class="item-control item-create" title="Create Enhancement" data-type="enhancement">
              <i class="fas fa-plus"></i> Add
            </a>
          </h3>
           <ul class="item-list">
            {{#each enhancements as |item|}}
              <li class="item flexrow" data-item-id="{{item._id}}">
                <div class="item-image"><img src="{{item.img}}" title="{{item.name}}" width="24" height="24"/></div>
                <h4 class="item-name">{{item.name}}</h4>
                <div class="item-controls">
                  <a class="item-control item-edit" title="Edit Item"><i class="fas fa-edit"></i></a>
                  <a class="item-control item-delete" title="Delete Item"><i class="fas fa-trash"></i></a>
                </div>
              </li>
            {{/each}}
          </ul>
        </section>
      </div>
    </div>

    <!-- BACKGROUNDS TAB (Legacy + Cybernetics) -->
    <div class="tab backgrounds" data-group="primary" data-tab="backgrounds">
      <div class="grid-2col">
        <section>
           <!-- Removed the old text-based backgrounds to avoid confusion with new Item-based ones, 
                or keep them if you want both systems temporarily. 
                I'm keeping Allegiances and Cybernetics here. -->
          <h3>Allegiances</h3>
          {{#each system.allegiances as |val key|}}
            <div class="resource">
              <label>{{capitalize key}}</label>
              <input type="text" name="system.allegiances.{{key}}" value="{{val}}"/>
            </div>
          {{/each}}
        </section>

        <section>
          <h3>
            Implants
            <a class="item-control item-create" title="Create Implant" data-type="implant">
              <i class="fas fa-plus"></i> Add
            </a>
          </h3>
          <div class="resource">
            <label>Immune Load</label>
            <!-- Read-only for now until we automate it completely -->
            <input type="number" name="system.cyber.immune_load" value="{{system.cyber.immune_load}}" min="0" max="20" readonly style="background:#eee;"/>
          </div>
          <ul class="item-list">
             {{#each implants as |item|}}
              <li class="item flexrow" data-item-id="{{item._id}}">
                <div class="item-image"><img src="{{item.img}}" title="{{item.name}}" width="24" height="24"/></div>
                <h4 class="item-name">{{item.name}}</h4>
                <div class="item-controls">
                  <a class="item-control item-edit" title="Edit Item"><i class="fas fa-edit"></i></a>
                  <a class="item-control item-delete" title="Delete Item"><i class="fas fa-trash"></i></a>
                </div>
              </li>
            {{/each}}
          </ul>
        </section>
      </div>
    </div>

    <!-- NOTES TAB -->
    <div class="tab notes" data-group="primary" data-tab="notes">
      <div class="resource" style="flex-direction:column; align-items:stretch;">
        <label>Notes</label>
        <textarea name="system.notes" rows="12">{{system.notes}}</textarea>
      </div>
    </div>
  </section>
</form>